<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A/B Test Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f9fc;
      padding: 2rem;
      color: #333;
    }
    h1 {
      font-weight: 600;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      max-width: 300px;
    }
    label {
      margin-top: 1rem;
      font-weight: bold;
    }
    input {
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.7rem;
      font-size: 1rem;
      background-color: #50c878;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #results {
      margin-top: 2rem;
      display: none;
      background: #fff;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    table {
      width: 100%;
      margin-top: 1rem;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
  </style>
</head>
<body>
  <h1>A/B Testing Calculator</h1>
  <div class="input-group">
    <label for="v1_passes">Design 1 (Successes)</label>
    <input type="number" id="v1_passes" />

    <label for="v1_total">Design 1 (Total)</label>
    <input type="number" id="v1_total" />

    <label for="v2_passes">Design 2 (Successes)</label>
    <input type="number" id="v2_passes" />

    <label for="v2_total">Design 2 (Total)</label>
    <input type="number" id="v2_total" />

    <button onclick="calculate()">Calculate</button>
  </div>

  <div id="results"></div>

 <script>
  // Log factorial to avoid overflow
  function logFactorial(n) {
    let result = 0;
    for (let i = 2; i <= n; i++) {
      result += Math.log(i);
    }
    return result;
  }

  // Hypergeometric p-value for 2x2 table
  function fisherExactTest(a, b, c, d) {
    const n = a + b + c + d;
    const logP = logFactorial(a + b) + logFactorial(c + d) + logFactorial(a + c) + logFactorial(b + d)
               - (logFactorial(a) + logFactorial(b) + logFactorial(c) + logFactorial(d) + logFactorial(n));
    return Math.exp(logP);
  }

  function calculate() {
    const v1_passes = parseInt(document.getElementById("v1_passes").value);
    const v1_total = parseInt(document.getElementById("v1_total").value);
    const v2_passes = parseInt(document.getElementById("v2_passes").value);
    const v2_total = parseInt(document.getElementById("v2_total").value);

    if (
      isNaN(v1_passes) || isNaN(v1_total) || isNaN(v2_passes) || isNaN(v2_total) ||
      v1_passes > v1_total || v2_passes > v2_total || v1_passes < 0 || v2_passes < 0
    ) {
      document.getElementById("results").style.display = "block";
      document.getElementById("results").innerHTML = "<p>Please enter valid numbers.</p>";
      return;
    }

    const a1 = v1_passes + 1;
    const b1 = v1_total - v1_passes + 1;
    const a2 = v2_passes + 1;
    const b2 = v2_total - v2_passes + 1;

    const sims = 100000;
    let wins = 0;
    for (let i = 0; i < sims; i++) {
      const s1 = jStat.beta.sample(a1, b1);
      const s2 = jStat.beta.sample(a2, b2);
      if (s1 > s2) wins++;
    }

    const p_dir = Math.round((wins / sims) * 100);
    const p_rev = 100 - p_dir;

    function classifyEvidence(p) {
      if (p === 50) return "No evidence (tie)";
      if (p > 50 && p <= 80) return "Weak evidence";
      if (p > 80 && p <= 95) return "Moderate evidence";
      if (p > 95 && p <= 99) return "Strong evidence";
      return "Very strong evidence";
    }

    const obs1 = Math.round((v1_passes / v1_total) * 100);
    const obs2 = Math.round((v2_passes / v2_total) * 100);
    const est1 = Math.round((a1 / (a1 + b1)) * 100);
    const est2 = Math.round((a2 / (a2 + b2)) * 100);

    const ci1_lo = Math.round(jStat.beta.inv(0.025, a1, b1) * 100);
    const ci1_hi = Math.round(jStat.beta.inv(0.975, a1, b1) * 100);
    const ci2_lo = Math.round(jStat.beta.inv(0.025, a2, b2) * 100);
    const ci2_hi = Math.round(jStat.beta.inv(0.975, a2, b2) * 100);

    // Fisher's Exact Test: 2x2 table
    const a = v1_passes;
    const b = v1_total - v1_passes;
    const c = v2_passes;
    const d = v2_total - v2_passes;
    const fisher_p = fisherExactTest(a, b, c, d);
    const significant = fisher_p < 0.05 ? "Yes" : "No";
    const z_score = fisher_p > 0 ? Math.round(jStat.normal.inv(1 - fisher_p / 2, 0, 1) * 1000) / 1000 : "N/A";

    const html = `
      <table>
        <tr><th>Variant</th><th>Observed P</th><th>Best Estimate P</th><th>CI Lower</th><th>CI Upper</th></tr>
        <tr><td>V1</td><td>${obs1}%</td><td>${est1}%</td><td>${ci1_lo}%</td><td>${ci1_hi}%</td></tr>
        <tr><td>V2</td><td>${obs2}%</td><td>${est2}%</td><td>${ci2_lo}%</td><td>${ci2_hi}%</td></tr>
      </table>

      <table>
        <tr><th>Metric</th><th>V1 > V2</th><th>V2 > V1</th></tr>
        <tr><td>P-Direction</td><td>${p_dir}%</td><td>${p_rev}%</td></tr>
        <tr><td>Evidence</td><td>${classifyEvidence(p_dir)}</td><td>${classifyEvidence(p_rev)}</td></tr>
      </table>

      <table>
        <tr><th>Statistical Test</th><th>Value</th></tr>
        <tr><td>Fisherâ€™s Exact P</td><td>${fisher_p.toFixed(5)}</td></tr>
        <tr><td>Statistically Significant?</td><td>${significant}</td></tr>
        <tr><td>Z-Score</td><td>${z_score}</td></tr>
      </table>
    `;

    const results = document.getElementById("results");
    results.style.display = "block";
    results.innerHTML = html;
  }
</script>

</body>
</html>
