<script>
function logFactorial(n) {
  let result = 0;
  for (let i = 2; i <= n; i++) result += Math.log(i);
  return result;
}

function logHypergeometric(a, b, c, d) {
  return logFactorial(a + b) + logFactorial(c + d) + logFactorial(a + c) + logFactorial(b + d)
       - (logFactorial(a) + logFactorial(b) + logFactorial(c) + logFactorial(d) + logFactorial(a + b + c + d));
}

function fisherExactP(a, b, c, d) {
  const n1 = a + b;
  const n2 = c + d;
  const observedLogP = logHypergeometric(a, b, c, d);
  const observedP = Math.exp(observedLogP);
  let p = 0;
  for (let x = 0; x <= Math.min(n1, a + c); x++) {
    let y = a + c - x;
    if (y < 0 || y > n2) continue;
    const prob = Math.exp(logHypergeometric(x, n1 - x, y, n2 - y));
    if (prob <= observedP + 1e-10) p += prob;
  }
  return p;
}

function classifyEvidence(p) {
  if (p === 50) return "No evidence";
  if (p > 50 && p <= 80) return "Weak evidence";
  if (p > 80 && p <= 95) return "Moderate evidence";
  if (p > 95 && p <= 99) return "Strong evidence";
  return "Very strong evidence";
}

function generateTakeaway(p, direction, simulatedWins, oddsRatio, winner, emoji) {
  if (p === 50) {
    return `<p>üß† There is no evidence favoring either design. Results are evenly split.</p>`;
  }
  const evidence = classifyEvidence(p);
  const loser = direction === "v1" ? "Design 2" : "Design 1";

  return `
    <p>üß† There is <strong>${evidence.toLowerCase()}</strong> that <strong>${winner}</strong> performs better than <strong>${loser}</strong>.</p>
    <p>üî¨ Simulated Wins: <strong>${winner}</strong> won <strong>${simulatedWins}</strong> out of 100,000 simulations ${emoji}</p>
    <p>üìä Odds Ratio: Users were <strong>${oddsRatio}</strong>√ó more likely to succeed with ${winner}</p>
  `;
}

function calculate() {
  const v1_passes = parseInt(document.getElementById("v1_passes").value);
  const v1_total = parseInt(document.getElementById("v1_total").value);
  const v2_passes = parseInt(document.getElementById("v2_passes").value);
  const v2_total = parseInt(document.getElementById("v2_total").value);

  if (
    isNaN(v1_passes) || isNaN(v1_total) ||
    isNaN(v2_passes) || isNaN(v2_total) ||
    v1_passes > v1_total || v2_passes > v2_total ||
    v1_passes < 0 || v2_passes < 0
  ) {
    alert("Please enter valid numbers.");
    return;
  }

  const a1 = v1_passes + 1, b1 = v1_total - v1_passes + 1;
  const a2 = v2_passes + 1, b2 = v2_total - v2_passes + 1;
  const sims = 100000;
  let wins = 0;
  for (let i = 0; i < sims; i++) {
    const s1 = jStat.beta.sample(a1, b1);
    const s2 = jStat.beta.sample(a2, b2);
    if (s1 > s2) wins++;
  }

  const p_dir = Math.round((wins / sims) * 100);
  const p_rev = 100 - p_dir;

  const obs1 = Math.round((v1_passes / v1_total) * 100);
  const obs2 = Math.round((v2_passes / v2_total) * 100);
  const est1 = Math.round((a1 / (a1 + b1)) * 100);
  const est2 = Math.round((a2 / (a2 + b2)) * 100);
  const ci1_lo = Math.round(jStat.beta.inv(0.025, a1, b1) * 100);
  const ci1_hi = Math.round(jStat.beta.inv(0.975, a1, b1) * 100);
  const ci2_lo = Math.round(jStat.beta.inv(0.025, a2, b2) * 100);
  const ci2_hi = Math.round(jStat.beta.inv(0.975, a2, b2) * 100);

  const a = v1_passes, b = v1_total - v1_passes;
  const c = v2_passes, d = v2_total - v2_passes;
  const fisher = fisherExactP(a, b, c, d);
  const sig = fisher < 0.05 ? "Yes" : "No";

  document.getElementById("obs1").textContent = `${obs1}%`;
  document.getElementById("obs2").textContent = `${obs2}%`;
  document.getElementById("est1").textContent = `${est1}%`;
  document.getElementById("est2").textContent = `${est2}%`;
  document.getElementById("ci1low").textContent = `${ci1_lo}%`;
  document.getElementById("ci1high").textContent = `${ci1_hi}%`;
  document.getElementById("ci2low").textContent = `${ci2_lo}%`;
  document.getElementById("ci2high").textContent = `${ci2_hi}%`;
  document.getElementById("pd1").textContent = `${p_dir}%`;
  document.getElementById("pd2").textContent = `${p_rev}%`;
  document.getElementById("ev1").textContent = p_dir > 50 ? classifyEvidence(p_dir) : "--";
  document.getElementById("ev2").textContent = p_rev > 50 ? classifyEvidence(p_rev) : "--";
  document.getElementById("fisher").textContent = fisher.toFixed(5);
  document.getElementById("sig").textContent = sig;

  const direction = p_dir > 50 ? "v1" : p_rev > 50 ? "v2" : "tie";
  const winner = direction === "v1" ? "Design 1" : direction === "v2" ? "Design 2" : "Neither design";
  const emoji = direction === "v1" ? "üíö" : direction === "v2" ? "üíô" : "‚öñÔ∏è";
  const simulatedWins = Math.round((Math.max(p_dir, p_rev) / 100) * sims);

  let oddsRatio = "N/A";
  if (v1_passes !== 0 && v2_passes !== 0 &&
      (v1_total - v1_passes) !== 0 && (v2_total - v2_passes) !== 0) {
    const odds1 = v1_passes / (v1_total - v1_passes);
    const odds2 = v2_passes / (v2_total - v2_passes);
    oddsRatio = (odds2 / odds1).toFixed(2);
  }

  try {
    const takeawayHTML = generateTakeaway(
      p_dir > 50 ? p_dir : p_rev,
      direction,
      simulatedWins,
      oddsRatio,
      winner,
      emoji
    );
    document.getElementById("takeaway").innerHTML = takeawayHTML;
  } catch (e) {
    document.getElementById("takeaway").innerText = "‚ö†Ô∏è Unable to display summary.";
    console.error("Error injecting summary:", e);
  }
}
</script>

